# 问题修复记录

## 最近一次修复

| 项目 | 内容 |
|------|------|
| **修复时间** | 2026-02-16 09:23:22 |
| **问题描述** | 性能优化后出现地址遗漏识别问题，具体字符为"甲25号写字楼230室"无法被识别 |
| **问题原因** | `extract_batch()` 方法返回格式与单个调用格式不一致：<br>- 单个调用返回：`[{'地址': [...]}]`（列表包含字典）<br>- 批量调用返回：`{'地址': [...]}`（直接是字典）<br>导致识别器遍历缓存结果时无法正确解析 |
| **修复方式** | 修改 `extract_batch()` 方法，将批量结果包装成列表格式，使其与单个调用返回格式保持一致 |
| **修复结果** | 地址识别恢复正常，"甲25号写字楼230室"等地址可正确识别 |

---

## 修改文件列表

### 1. `src/cn_pii_anonymization/nlp/ie_engine.py`
- 修改 `extract_batch()` 方法：将批量结果包装成列表格式 `[result]`，与单个调用格式保持一致

---

## 历史修复记录

| 日期 | 问题 | 修复方式 |
|------|------|----------|
| 2026-02-16 | 地址遗漏识别问题 | 修复批量调用返回格式不一致 |
| 2026-02-15 | 图片脱敏性能问题 | 批量分析+IE缓存优化 |

---

## 详细修复记录

### 2026-02-16 地址遗漏识别问题

**问题背景：**
在性能优化后，发现部分地址无法被正确识别，如"甲25号写字楼230室"。

**问题分析：**
1. IE引擎本身能正确识别地址（验证通过）
2. 问题出在 `extract_batch()` 方法的返回格式
3. PaddleNLP Taskflow 批量调用返回格式与单个调用不同：
   - 单个调用：`ie("text")` → `[{'地址': [...]}]`
   - 批量调用：`ie(["text1", "text2"])` → `[{'地址': [...]}, {'地址': [...]}]`
4. 在 `extract_batch()` 中，每个 `result` 是字典而非列表，导致识别器无法正确解析

**修复代码：**
```python
# 修复前
results_map[orig_text] = result if result else []

# 修复后
if result and isinstance(result, dict):
    results_map[orig_text] = [result]  # 包装成列表格式
else:
    results_map[orig_text] = []
```

### 2026-02-15 图片脱敏性能问题

**问题背景：**
使用图片脱敏功能时，如果OCR结果文字较多，单张图片的处理时间很长。

**问题分析：**
1. OCR文本框串行PII分析：对每个OCR文本框串行调用分析器
2. IE引擎重复调用：每个文本框都会单独调用IE引擎进行姓名/地址识别
3. 缺乏文本去重：相同文本被重复分析

**修复方式：**
1. 实现批量分析方法 `analyze_batch()`：预先批量调用IE引擎处理所有文本
2. 添加IE结果缓存机制：识别器支持缓存，避免重复调用IE引擎
3. 文本去重优化：对OCR结果进行去重，相同文本只分析一次
4. IE引擎批量处理：添加 `extract_batch()` 方法支持批量文本处理
